(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{566:function(e,l,t){"use strict";t.r(l);var a=t(0),s=Object(a.a)({},(function(){var e=this,l=e.$createElement,t=e._self._c||l;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"using-the-oracle-data"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#using-the-oracle-data"}},[e._v("#")]),e._v(" Using the Oracle Data")]),e._v(" "),t("p",[e._v("In order to use the data provided by the Oracle module, we must make sure all validators come to a consensus about what is commeted to the blockchain state.")]),e._v(" "),t("p",[e._v("While the Oracle module provides some helper methods, the app developer is ultimately responsible for doing this.")]),e._v(" "),t("h2",{attrs:{id:"reaching-consensus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reaching-consensus"}},[e._v("#")]),e._v(" Reaching Consensus")]),e._v(" "),t("p",[e._v("Plan of action:")]),e._v(" "),t("ul",[t("li",[e._v("In our app's EndBlock, query the pending oracle rounds")]),e._v(" "),t("li",[e._v("If we have enough votes to reach consensus, compute the average result of all claims")]),e._v(" "),t("li",[e._v("Write the result on-chain.")])]),e._v(" "),t("p",[e._v("First we need to make sure we add our app to the EndBlock handler. Add your app to "),t("code",[e._v("SetOrderEndBlockers")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"CWFwcC5tbS5TZXRPcmRlckVuZEJsb2NrZXJzKGNyaXNpc3R5cGVzLk1vZHVsZU5hbWUsIGdvdnR5cGVzLk1vZHVsZU5hbWUsIHN0YWtpbmd0eXBlcy5Nb2R1bGVOYW1lLCAmbHQ7eW91cl9hcHBfdHlwZXMmZ3Q7Lk1vZHVsZU5hbWUpCg=="}}),e._v(" "),t("p",[e._v("We will also need to import the Oracle keeper into our app's keeper.")]),e._v(" "),t("p",[e._v("add "),t("code",[e._v("types/expected_keepers.go")])]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSB0eXBlcwoKaW1wb3J0ICgKCXNkayAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzJnF1b3Q7CglvcmFjbGUgJnF1b3Q7Z2l0aHViLmNvbS9yZWxldmFudC1jb21tdW5pdHkvb3JhY2xlL3gvb3JhY2xlL2V4cG9ydGVkJnF1b3Q7CglvcmFjbGV0eXBlcyAmcXVvdDtnaXRodWIuY29tL3JlbGV2YW50LWNvbW11bml0eS9vcmFjbGUveC9vcmFjbGUvdHlwZXMmcXVvdDsKCXRtYnl0ZXMgJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvbGlicy9ieXRlcyZxdW90OwopCgp0eXBlICgKCS8vIE9yYWNsZUtlZXBlciBpbnRlcmZhY2UKCU9yYWNsZUtlZXBlciBpbnRlcmZhY2UgewoJCUZpbmFsaXplUm91bmQoY3R4IHNkay5Db250ZXh0LCBjbGFpbVR5cGUgc3RyaW5nLCByb3VuZElEIHVpbnQ2NCkKCQlHZXRQZW5kaW5nUm91bmRzKGN0eCBzZGsuQ29udGV4dCwgcm91bmRUeXBlIHN0cmluZykgKHJvdW5kcyBbXXVpbnQ2NCkKCQlUYWxseVZvdGVzKGN0eCBzZGsuQ29udGV4dCwgY2xhaW1UeXBlIHN0cmluZywgcm91bmRJRCB1aW50NjQpICpvcmFjbGV0eXBlcy5Sb3VuZFJlc3VsdAoJCUdldENsYWltKGN0eCBzZGsuQ29udGV4dCwgaGFzaCB0bWJ5dGVzLkhleEJ5dGVzKSBvcmFjbGUuQ2xhaW0KCX0KKQo="}}),e._v(" "),t("p",[e._v("your "),t("code",[e._v("keeper/keeper.go")]),e._v(" file should look like this:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"CnR5cGUgKAoJS2VlcGVyIHN0cnVjdCB7CgkJY2RjICAgICAgICAgIGNvZGVjLk1hcnNoYWxlcgoJCXN0b3JlS2V5ICAgICBzZGsuU3RvcmVLZXkKCQltZW1LZXkgICAgICAgc2RrLlN0b3JlS2V5CgkJb3JhY2xlS2VlcGVyIHR5cGVzLk9yYWNsZUtlZXBlcgoJfQopCgpmdW5jIE5ld0tlZXBlcihjZGMgY29kZWMuTWFyc2hhbGVyLCBzdG9yZUtleSwgbWVtS2V5IHNkay5TdG9yZUtleSwgb3JhY2xlS2VlcGVyIHR5cGVzLk9yYWNsZUtlZXBlcikgKktlZXBlciB7CglyZXR1cm4gJmFtcDtLZWVwZXJ7CgkJY2RjOiAgICAgICAgICBjZGMsCgkJc3RvcmVLZXk6ICAgICBzdG9yZUtleSwKCQltZW1LZXk6ICAgICAgIG1lbUtleSwKCQlvcmFjbGVLZWVwZXI6IG9yYWNsZUtlZXBlciwKCX0KfQo="}}),e._v(" "),t("p",[e._v("Finallly, make sure to update your app's keeper constructor inside "),t("code",[e._v("app.go")]),e._v(" file if needed.")]),e._v(" "),t("h2",{attrs:{id:"tally-the-votes"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tally-the-votes"}},[e._v("#")]),e._v(" Tally the Votes")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayBLZWVwZXIpIFVwZGF0ZUF0b21Vc2QoY3R4IHNkay5Db250ZXh0KSB7CgljbGFpbVR5cGUgOj0gdHlwZXMuQXRvbUNsYWltCglwZW5kaW5nIDo9IGsub3JhY2xlS2VlcGVyLkdldFBlbmRpbmdSb3VuZHMoY3R4LCBjbGFpbVR5cGUpCgoJLy8gc29ydCBwZW5kaW5nIHJvdW5kcyBpbiBhc2NlbmRpbmcgb3JkZXIKCXNvcnQuU2xpY2VTdGFibGUocGVuZGluZywgZnVuYyhpLCBqIGludCkgYm9vbCB7IHJldHVybiBwZW5kaW5nW2ldICZsdDsgcGVuZGluZ1tqXSB9KQoKCWZvciBfLCByb3VuZElEIDo9IHJhbmdlIHBlbmRpbmcgewoJCXJlc3VsdCA6PSBrLm9yYWNsZUtlZXBlci5UYWxseVZvdGVzKGN0eCwgY2xhaW1UeXBlLCByb3VuZElEKQoKCQlpZiByZXN1bHQgPT0gbmlsIHx8IHJlc3VsdC5DbGFpbXNbMF0gPT0gbmlsIHsKCQkJY29udGludWUKCQl9CgoJCS8vIHRha2UgYW4gYXZlcmFnZSBvZiBhbGwgY2xhaW1zIGFuZCBjb21taXQgdG8gY2hhaW4KCQlhdmdBdG9tVXNkIDo9IHNkay5OZXdEZWMoMCkKCQl2YXIgYmxvY2tIZWlnaHQgaW50NjQKCQl2YXIgdG90YWxWb3RlUG93ZXIgaW50NjQKCQlmb3IgXywgY2xhaW1SZXN1bHQgOj0gcmFuZ2UgcmVzdWx0LkNsYWltcyB7CgkJCWNsYWltSGFzaCA6PSBjbGFpbVJlc3VsdC5DbGFpbUhhc2gKCQkJYXRvbUNsYWltLCBvayA6PSBrLm9yYWNsZUtlZXBlci5HZXRDbGFpbShjdHgsIGNsYWltSGFzaCkuKCp0eXBlcy5BdG9tVXNkKQoKCQkJaWYgb2sgPT0gZmFsc2UgewoJCQkJZm10LlByaW50ZigmcXVvdDtFcnJvciByZXRyaWV2aW5nIGNsYWltJnF1b3Q7KQoJCQkJY29udGludWUKCQkJfQoJCQl3ZWlnaHRlZEF2ZyA6PSBhdmdBdG9tVXNkLk11bChzZGsuTmV3RGVjKHRvdGFsVm90ZVBvd2VyKSkKCQkJd2VpZ2h0ZWRWb3RlIDo9IGF0b21DbGFpbS5QcmljZS5NdWwoc2RrLk5ld0RlYyhyZXN1bHQuVm90ZVBvd2VyKSkKCQkJdG90YWxWb3RlUG93ZXIgKz0gcmVzdWx0LlZvdGVQb3dlcgoJCQlhdmdBdG9tVXNkID0gd2VpZ2h0ZWRBdmcuQWRkKHdlaWdodGVkVm90ZSkuUXVvKHNkay5OZXdEZWModG90YWxWb3RlUG93ZXIpKQoJCQlibG9ja0hlaWdodCA9IGF0b21DbGFpbS5CbG9ja0hlaWdodAoJCX0KCgkJYXRvbVVzZCA6PSAmYW1wO3R5cGVzLkF0b21Vc2R7CgkJCVByaWNlOiAgICAgICBhdmdBdG9tVXNkLAoJCQlCbG9ja0hlaWdodDogYmxvY2tIZWlnaHQsCgkJfQoJCWsuU2V0QXRvbVVzZChjdHgsICphdG9tVXNkKQoKCQkvLyBUT0RPIGRlbGV0ZSB0aGUgYW55IGVhcmxpZXIgcGVuZGluZyByb3VuZHMKCQlrLm9yYWNsZUtlZXBlci5GaW5hbGl6ZVJvdW5kKGN0eCwgY2xhaW1UeXBlLCByb3VuZElEKQoJfQp9Cg=="}}),e._v(" "),t("p",[e._v("Here is what happens in the code above:")]),e._v(" "),t("ul",[t("li",[e._v("We get all 'PendingRounds' from the oracleKeeper and sort them in ascending order so we can process the early claims first")]),e._v(" "),t("li",[e._v("For each pending round, we tally the votes using the oracleKeeper's "),t("code",[e._v("TallyVotes")]),e._v(" method. If consensus threshold we specified in the params is reached, "),t("code",[e._v("TallyVotes")]),e._v(" returns a "),t("code",[e._v("RoundResult")]),e._v(" struct.")])]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBDbGFpbVZvdGVSZXN1bHQgc3RydWN0IHsKCUNsYWltSGFzaCB0bWJ5dGVzLkhleEJ5dGVzCglWb3RlUG93ZXIgaW50NjQKfQoKLy8gUm91bmRSZXN1bHQgaXMgaXMgYSByZWNvcmQgb2Ygdm90ZSB0YWxsaWVzIGZvciBhIGdpdmVuIHJvdW5kCnR5cGUgUm91bmRSZXN1bHQgc3RydWN0IHsKCVZvdGVQb3dlciAgaW50NjQKCVRvdGFsUG93ZXIgaW50NjQKCUNsYWltVHlwZSAgc3RyaW5nCglDbGFpbXMgICAgIFtdKkNsYWltVm90ZVJlc3VsdAp9Cg=="}}),e._v(" "),t("ul",[t("li",[e._v("We iterate through the round result's "),t("code",[e._v("Claims")]),e._v(" field, fetch the "),t("code",[e._v("Claim")]),e._v(" and weigh the price by the validators power. This gives us an average submission price weighted by validator power.")]),e._v(" "),t("li",[e._v("Write the final result on-chain along with the Claim's BlockHeight")])]),e._v(" "),t("ul",[t("li",[e._v("Note in reality you may want to use weighted median value rather than a weighted average.")])]),e._v(" "),t("h2",{attrs:{id:"run-updateatomusd-in-modules-s-endblock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#run-updateatomusd-in-modules-s-endblock"}},[e._v("#")]),e._v(" Run UpdateAtomUsd in modules's EndBlock")]),e._v(" "),t("p",[e._v("Update your module's EndBlock method in "),t("code",[e._v("module.go")])]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoYW0gQXBwTW9kdWxlKSBFbmRCbG9jayhjdHggc2RrLkNvbnRleHQsIF8gYWJjaS5SZXF1ZXN0RW5kQmxvY2spIFtdYWJjaS5WYWxpZGF0b3JVcGRhdGUgewoJYW0ua2VlcGVyLlVwZGF0ZUF0b21Vc2QoY3R4KQoJcmV0dXJuIFtdYWJjaS5WYWxpZGF0b3JVcGRhdGV7fQp9Cg=="}}),e._v(" "),t("h2",{attrs:{id:"query-the-atomusd-price"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#query-the-atomusd-price"}},[e._v("#")]),e._v(" Query the AtomUsd Price")]),e._v(" "),t("p",[e._v("As a final step we add the querier and cli methods to fetch the on-chain price. You consult the starport examples on how to do this, or simply view the final result here: https://github.com/relevant-community/oracle/tree/main/x/atom")])],1)}),[],!1,null,null,null);l.default=s.exports}}]);